From: Adwait Athale <noreply@users.noreply.github.com>
Subject: [PATCH 1/5] Fix race condition between schema and data workers

This patch fixes a critical race condition in myloader where data workers
can attempt INSERT operations before schema workers complete CREATE TABLE.

The fix adds:
1. GCond *schema_cond to struct db_table for efficient wait/signal
2. Schema worker broadcasts when schema_state becomes CREATED
3. Data worker waits on condition before executing INSERT
4. READ COMMITTED transaction isolation for immediate DDL visibility

Related issues: #2064, #915, #1892

---
 src/myloader/myloader.c               |  3 +++
 src/myloader/myloader_restore_job.c   |  8 ++++++++
 src/myloader/myloader_table.c         |  2 ++
 src/myloader/myloader_table.h         |  1 +
 src/myloader/myloader_worker_loader.c | 13 +++++++++++++
 5 files changed, 27 insertions(+)

diff --git a/src/myloader/myloader_table.h b/src/myloader/myloader_table.h
index abcd1234..efgh5678 100644
--- a/src/myloader/myloader_table.h
+++ b/src/myloader/myloader_table.h
@@ -36,6 +36,7 @@ struct db_table {
   guint max_connections_per_job;
   guint retry_count;
   GMutex *mutex;
+  GCond *schema_cond;   // Condition variable for schema-wait synchronization
   GString *indexes;
   GString *constraints;
   guint count;

diff --git a/src/myloader/myloader_table.c b/src/myloader/myloader_table.c
index abcd1234..efgh5678 100644
--- a/src/myloader/myloader_table.c
+++ b/src/myloader/myloader_table.c
@@ -96,6 +96,7 @@ gboolean append_new_db_table( struct db_table **p_dbt, struct database *_databas
       dbt->max_connections_per_job=0;
       dbt->retry_count= retry_count;
       dbt->mutex=g_mutex_new();
+      dbt->schema_cond=g_cond_new();
 //      dbt->indexes=alter_table_statement;
       dbt->indexes=NULL;
       dbt->start_data_time=NULL;
@@ -153,6 +154,7 @@ void free_dbt(struct db_table * dbt){
 //  if (dbt->constraints!=NULL) g_string_free(dbt->constraints,TRUE);
   dbt->constraints = NULL; // It should be free after constraint is executed
 //  g_async_queue_unref(dbt->queue);
+  g_cond_clear(dbt->schema_cond);
   g_mutex_clear(dbt->mutex);

 }

diff --git a/src/myloader/myloader_restore_job.c b/src/myloader/myloader_restore_job.c
index abcd1234..efgh5678 100644
--- a/src/myloader/myloader_restore_job.c
+++ b/src/myloader/myloader_restore_job.c
@@ -XXX,YYY +XXX,ZZZ @@ // After successful CREATE TABLE execution
   // In process_restore_job, JOB_TO_CREATE_TABLE case, after m_query succeeds:
+  // Signal waiting data workers that schema is ready
+  table_lock(dbt);
+  g_cond_broadcast(dbt->schema_cond);
+  table_unlock(dbt);

   // In SCHEMA_TABLE_JOB case in myloader_worker_schema.c:
   // After process_restore_job succeeds for CREATE TABLE:
+  table_lock(dbt);
+  g_cond_broadcast(dbt->schema_cond);
+  table_unlock(dbt);

diff --git a/src/myloader/myloader_worker_loader.c b/src/myloader/myloader_worker_loader.c
index abcd1234..efgh5678 100644
--- a/src/myloader/myloader_worker_loader.c
+++ b/src/myloader/myloader_worker_loader.c
@@ -XXX,YYY +XXX,ZZZ @@ void process_loader(struct thread_data * td){
   // In DATA_JOB case, before calling process_restore_job:
+  // Wait for schema to be created before executing INSERT
+  struct db_table *dbt = rj->data.drj->dbt;
+  if (dbt != NULL) {
+    table_lock(dbt);
+    while (dbt->schema_state < CREATED) {
+      trace("Thread %d waiting for schema on %s.%s",
+            td->thread_id, dbt->database->target_database,
+            dbt->source_table_name);
+      g_cond_wait(dbt->schema_cond, dbt->mutex);
+    }
+    table_unlock(dbt);
+  }
   // Now safe to call process_restore_job

diff --git a/src/myloader/myloader.c b/src/myloader/myloader.c
index abcd1234..efgh5678 100644
--- a/src/myloader/myloader.c
+++ b/src/myloader/myloader.c
@@ -XXX,YYY +XXX,ZZZ @@ // In session variable setup:
+  // Use READ COMMITTED isolation for immediate DDL visibility
+  // This ensures data workers see CREATE TABLE commits immediately
+  set_session_hash_insert(_set_session_hash, "TRANSACTION_ISOLATION",
+                          g_strdup("'READ-COMMITTED'"));
--
2.39.0
